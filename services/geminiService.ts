
import { GoogleGenAI } from "@google/genai";
import { PropertyFormData } from "../types";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

export const generateRealEstateAd = async (data: PropertyFormData): Promise<string> => {
  const model = "gemini-2.5-flash";

  let prompt = "";

  if (data.propertyCategory === 'showroom') {
    // Specialized Prompt for Showroom Video Script
    prompt = `
      أنت كاتب محتوى فيديو عقاري محترف لدى "شركة فارس الصحراء العقارية".
      مهمتك هي كتابة سكريبت فيديو لإعلان معرض سيارات بناءً على البيانات التالية.
      
      **يجب عليك اتباع النموذج النصي التالي بدقة شديدة، وتعبئة الفراغات [بين الأقواس] بالبيانات المقدمة:**

      **النموذج النصي (يجب تعبئته):**
      "في شرق ${data.city}، وتحديداً في حي [${data.district}] ضمن منطقة معارض السيارات، يتوفر معرض سيارات قائم يتمتع بموقع استراتيجي داخل سوق نشط يشهد حركة تجارية يومية متصاعدة. يقع المعرض على أرض تبلغ مساحتها [${data.area}] متر مربع، على [${data.showroomStreetsCount}] بعرض [${data.showroomStreetsWidth}] متراً، وبواجهة واتجاه [${data.showroomFacing}] يمنحه حضوراً مميزاً وسط السوق ويجعله نقطة جذب للعملاء والمستثمرين على حد سواء.
      المعرض مشيّد على كامل مساحة الأرض بهنقر واسع يوفّر سعة مثالية لعرض عدد [${data.showroomCapacity}] سيارة، مع تصميم داخلي مدروس يسهّل حركة المركبات ويمنح مساحة تشغيل عملية ومريحة. وقد جُهّز المعرض بكامل احتياجات التشغيل الاحترافي، [${generateFacilitiesText(data)}]، ودورات مياه مجهّزة بعناية. كما تتميز أرضية المعرض بكونها مهيّأة بشكل خاص لنشاط بيع وعرض السيارات، مع وجود مداخل ومخارج واسعة تضمن انسيابية عالية في الدخول والخروج.
      ويحظى الموقع بميزة استراتيجية فريدة بفضل قربه من أهم الطرق الحيوية في ${data.city}؛ حيث انه يقع على شارع [${data.siteStreetName}] المتصل بـ[${data.road1Name}] من الجهة [${data.road1Dir}]، و[${data.road2Name}] من الجهة [${data.road2Dir}]${data.road3Name ? `، إضافةً إلى [${data.road3Name}] من الجهة [${data.road3Dir}]` : ''}، مما يمنح المعرض سهولة وصول استثنائية من مختلف الجهات ويجعله خياراً مثالياً للنشاط التجاري.
      يمثل هذا المعرض فرصة استثمارية ذهبية تتناسب مع شركات معارض السيارات، والمستثمرين الأفراد، والجهات الاستثمارية الباحثة عن موقع جاهز ومؤجّر لتحقيق عوائد سنوية قوية ضمن سوق يشهد نمواً مستمراً. ومع توسّع ${data.city} وارتفاع الطلب على المواقع التجارية المتميزة، تتعزز قيمة هذا الموقع بوصفه استثماراً طويل الأمد عالي الجدوى.
      شركة فارس الصحراء العقارية… أهم المواقع، أفضل الفرص.
      للتواصل: أرقامنا على الشاشة."

      **البيانات المدخلة:**
      ${JSON.stringify(data, null, 2)}

      **التعليمات:**
      1. استبدل ما بداخل الأقواس المربعة بالبيانات الفعلية.
      2. إذا كانت هناك حقول فارغة (مثل اسم شارع ثالث)، قم بصياغة الجملة لتبدو طبيعية أو احذف الجزء الخاص بها بذكاء دون الإخلال بالسياق، لكن يفضل الالتزام بالهيكل.
      3. لا تضف أي مقدمات أو خاتمات خارج النص المطلوب.
    `;
  } else {
    // Land Prompt (Existing style)
    prompt = `
      أنت كاتب محتوى عقاري محترف تعمل لدى "شركة فارس الصحراء العقارية".
      مهمتك هي صياغة إعلان عقاري جذاب واحترافي لـ "أرض فضاء" بناءً على البيانات المقدمة.
      
      **البيانات:**
      ${JSON.stringify(data, null, 2)}

      **التعليمات:**
      1. ركز على موقع الأرض، مساحتها، وأطوالها.
      2. استخدم نبرة فخمة واحترافية.
      3. الخاتمة: "شركة فارس الصحراء العقارية… أهم المواقع، أفضل الفرص."
    `;
  }

  try {
    const response = await ai.models.generateContent({
      model: model,
      contents: prompt,
    });
    return response.text || "حدث خطأ أثناء توليد النص.";
  } catch (error) {
    console.error("Error generating ad:", error);
    return "عذراً، حدث خطأ في الاتصال بالخدمة الذكية. يرجى المحاولة مرة أخرى.";
  }
};

// Helper to generate the facilities string
function generateFacilitiesText(data: PropertyFormData): string {
  const parts = [];
  if (data.hasOffices) parts.push("مكاتب مخصصة للموظفين");
  if (data.hasLounge) parts.push("مجلس لاستقبال العملاء");
  if (data.hasKitchen) parts.push("مطبخ يخدم الموظفين والزوار");
  
  if (parts.length === 0) return "مرافق خدمات متكاملة";
  return parts.join("، و");
}
